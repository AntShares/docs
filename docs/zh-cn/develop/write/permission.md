# 智能合约的权限管理

## Manifest 中的权限相关的字段

在合约的 Manifest 文件中定义了三个与权限相关的字段，如下：

| 字段        | 类型                        | 说明                                                         |
| ----------- | --------------------------- | ------------------------------------------------------------ |
| Groups      | ContractGroup[]             | 定义一组相互信任的合约。由公钥和对合约Hash的签名组成         |
| Permissions | ContractPermission[]        | 该字段是一个包含一个权限对象的数组，它描述了这个合约 **想要** 调用哪些其它合约的哪些方法。其中合约可以是 ScriptHash，可以是 Group，或通配符 *。方法是方法名或通配符 *。如果一个合约在运行时调用了一个没有在 manifest 中声明的合约或方法，则调用将失败 |
| Trusts      | WildcardContainer\<UInt160> | 其中合约可以是 ScriptHash，可以是Group，或通配符 *该合约信任哪些合约。如果一个合约是可信的，那么当合约调用时，用户界面将不会给出任何警告。 |

Groups 和  Trusts 只是用来给钱包看的字段，钱包会根据合约之间是否可信，或者合约是否在同一组中来决定是否给用户安全警告。

真正决定合约能否互相调用的是 Permissions 和下方介绍的签名作用域。

## 签名作用域（WitnessScope）

签名作用域定义的用户签名的可用范围，通过它能防止未经授权的合约随意使用用户签名。

- None：空，只对交易签名，不允许任何合约使用该签名
- CalledByEntry：只作用链式调用的入口，比如用户调用 A 合约，那么只有 A 合约可以使用签名，A 合约再调用 B 合约，在 B 合约中是不能使用用户的签名的。建议作为钱包的默认签名作用。
- CustomContracts：自定义合约，在指定的合约中可以使用该签名。可与 CalledByEntry 配合使用。
- CustomGroups：自定义合约组，在指定的合约组中可以使用该签名。可与 CalledByEntry 配合使用。
- Global ：全局。风险极高，合约有可能会转移你地址中的所有资产，除非用户极其信任该合约。

## 调用标志（CallFlags）

管理链式调用中被调用合约的行为。

应用场景：

在调用链中，交易→合约A →合约B

允许合约A写存储区，阻止合约B写存储区，阻止B继续调用其它合约。

CallFlags 值如下：

- None：被调用的合约无特殊权限
- ReadStates：被调用的合约可以读取存储区
- WriteStates：被调用的合约可以定稿存储区
- AllowCall：被调用的合约可以调用其它合约
- AllowNotify：被调用的合约可以发送通知
- States：被调用的合约可以读取和定稿存储区
- ReadOnly：被调用的合约可以读取存储区，可以调用其它合约
- All：被调用的合约可以读取和定入存储区，可以调用其它合约，可以发送通知

## 举例及详细说明

|             | 智能合约                   | 类比手机 App               |
| ----------- | -------------------------- | -------------------------- |
| Permissions | 该合约想要调用哪些合约     | App 向用户或系统申请的权限 |
| 签名作用域  | 用户对签名的作用范围的授权 | 用户或系统授予 App 的权限  |
| Trusts      | 该合约信任哪些合约         |                            |
| Groups      | 定义一组相互信任的合约     |                            |

当 A 合约调用 B 合约时，钱包应该如何提示用户以及如何设置签名作用域

| 举例                                                         | 钱包如何提示                                                 | 钱包设置签名作用域                                | 合约预期行为 |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------- | ------------ |
| A 合约的 Permissions 不包括 B 合约                           | 无                                                           | 默认                                              | 禁止调用     |
| A 合约的 Permissions 包括 B 合约<br/>A 合约和 B 合约在同一 Groups 且 Groups 签名验证通过 | 无                                                           | 在默认基础上增加 CustomGroups                     | 允许调用     |
| A 合约的 Permissions 包括 B 合约<br/>B 合约的 Tursts 包括 A 合约 | 无                                                           | 在默认基础上增加CustomContract                    | 允许调用     |
| A 合约的 Permissions 包括 B 合约<br/>B 合约的 Tursts 不包括 A 合约 | 提示 A 将调用 B 合约，可能有风险，询问是否将签名授权给 B 合约 | 设置为默认，并根据用户决定是否增加 CustomContract | 由用户决定   |
| A 合约的 Permissions 包括一个 Groups B                       | 提示 A 将调用 B 组中的任意合约，可能有风险，询问是否将签名授权给 B 组 | 设置为默认，并根据用户决定是否增加 CustomGroups   | 由用户决定   |
| A 合约的 Permissions 中合约为通配符 \*，方法为 m<br/>{"contract":"\*", "method": "m"} | 提示 A 将调用任意合约的 m 方法，可能有风险，询问是否将签名授权给 B 合约 | 根据用户决定，设置为默认或 Global                 | 由用户决定   |
| A 合约的 Permissions 中合约为通配符 \*，方法为通配符 \*<br/>{"contract":"\*", "method": "*"} | 提示 A 将调用任意合约的任意方法，可能有风险，询问是否将签名设置为 全局 | 根据用户决定，设置为默认或 Global                 | 由用户决定   |

- 钱包的默认签名作用域建议为 CalledByEntry