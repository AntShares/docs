# NEOノードによるプライベートチェーンのビルド

以前のチュートリアルで、WindowsやLinux上でノードの設定やデプロイをする方法を学びました。本チュートリアルでは、プライベートチェーン、すなわちアライアンスチェーンのビルド方法や、プライベートチェーンからNEOやGASを取り出すのに必要な手順についてお教えします。

NEOプライベートチェーンをデプロイするには、コンセンサスに達するために少なくとも4つのサーバが必要で、各サーバは、コンセンサスノードと専用NEOウォレットに対応します。

## 1. 仮想マシンの設定

NEOプライベートチェーンをデプロイするには、コンセンサスに達するために少なくとも4つのサーバが必要で、各サーバは、コンセンサスノードと専用NEOウォレットに対応します。デモンストレーションのために、Azureで4つのWindows仮想マシン作成しました。そのサイズはスタンダードDS1 v2(1 core、3.5GB RAM)です。あなたはLANや仮想マシン上にプライベートチェインをデプロイできます。

![image](http://docs.neo.org/images/2017-05-17_15-18-43.jpg)

作成後は、10331-10334ポートを開くため、新たなルールを確立します。具体的には、システムの`firewall` `advanced setting` `inbound rules`で、ルールを作成します。そしてポート10331-10334を追加します。

> [!注意]
> クラウドサーバ上で仮想マシンを作成する場合、仮想マシンのアドミニストレーティブバックグラウンドにログインし、ネットワークのセキュリティグループを設定します。
>
> Azureの設定方法は：`network interface` `network security group` `inbound security rules` `add`に、ポート10331-10334を追加します。

仮想マシンを作成したら、後で使用するため4つの仮想マシンのIPアドレスを保存します。

## 2. NEOノードのインストール

NEOノードのインストールプロセスは、前述で詳細に説明されています。NEOノードインストールの説明を参照してください(setup.md)。

## 3. ウォレットの作成

まず、4つのウォレットファイルwallet1.db3 - wallet4.db3を作成しました。この手順はPCバージョンのウォレット、コマンドラインウォレットの両方で実行し得ます。次の図はコマンドラインウォレットのスクリーンショットです。

![image](http://docs.neo.org/images/2017-05-17_11-17-30.jpg)

ウォレットを作成し、対応するパブリックキーを保存したら（i.e. テキストファイルに保存されます）、パブリックキーを直接コピーするか、CLI Commandのlist keyコマンドを使ってパブリックキーを表示し、それをコピーします。

その後、4つの仮想マシンのノードディレクトリに4つのウォレットをコピーします。

## 4. ノードのコンフィグレーションファイルファイルの変更

ノードのコンフィグレーションファイル`protocol.json`を開きます。

まずMagic の値を変更します。Magicはメッセージのソースネットワークを識別するのに使用します。異なるMagicを指定することで、NEOブロック内の異なるネットワーク情報が、転送の際、他のネットワークに確実に送信されないようにします。

> [!注意]
> Magicのタイプはuintのため、値は[0 - 4294967295]の範囲で設定することに注意してください。

`StandbyValidators`を修正し、手順3で記録されている4つのパブリックキーで満たします。

最後にSeedListを修正し、最初の手順で記録されたIPアドレスで満たします。ポート番号は不変です。例として、次のようにコンフィグレーションを変更しました。

```json
{
  "ProtocolConfiguration": {
    "Magic": 1704630,
    "AddressVersion": 23,
    "StandbyValidators": [
"02f27545181beb8f528d13bbb66d279db996ecb56ed9a324496d114acb48aa7a32",
      "02daa386d979ae6643869a365294055546023acb332ee1a74a5ae5d54774a97bac",
      "0306f12f7217569cdbe9dde9ff702d0040e0a4570873eee63291adaa658128e55c",
      "035781b4d55dc58187f61b5d9277afbaae425deacc5df57f9891f3a5c73ecb24df"
   ],
    "SeedList": [
      "13.75.112.62:10333",
      "137.116.173.200:10333",
      "168.63.206.73:10333",
      "137.116.171.134:10333"
   ],
    "SystemFee": {
      "EnrollmentTransaction": 0,
      "IssueTransaction": 0,
      "PublishTransaction": 0,
      "RegisterTransaction": 0
    }
  }
}
```

SystemFeeはシステムのfeeで、現在のfeeは次のようになります（単位はGAS）：

ブックキーパーの登録 - 1000、アセットの分配 - 500、スマートコントラクト - 500、アセットの登録 - 10000

プライベードチェーンにおいて、システムfeeを設定できます。

最後に、修正した`protocol.json`を4つのノードのクライアントディレクトリへ移動し、以前のprotocol.jsonを置き換えます。

それから4つの仮想マシン内で、下記のコマンドを入力してノードを開始し、ウォレットを開き、コンセンサスプロセスを開始します。分からない場合は、[CLIコマンドリファレンス](cli.md)を参照してください。

ノードの開始:

`Dotnet neo-cli.dll`

ウォレットのオープン:

`Open wallet wallet1.db3`

注意：すべてのノードがウォレット1を開くのではなく、各ノードで対応するウォレットファイルを開く必要があります。

`Start consensus`

上記の操作が成功した場合、4つのノードは以下に示すようにコンセンサスプロセスを開始します。

![image](http://docs.neo.org/images/2017-05-17_14-58-10.jpg)

4つのノードは以下のように1つの仮想マシンがオフになっていても、コンセンサスを達成できます。

![image](http://docs.neo.org/images/2017-05-17_14-57-51.jpg)



## 5. NEOとGASの取り出し

PCバージョンのクライアントをインストールし(NEO-GUI)、コンフィグレーションファイルprotocol.jsonを修正して、プライベートチェーンに接続します。

ウォレットを開きます。左下隅のコネクション番号がゼロでなく、同じブロックに同期されている場合、クライアントはプライベートチェーンへの接続が成功していることを意味します。

以下に示すように、PCクライアントでwallet1.db3を開き、マルチシグネチャアドレスを追加し、protocol.json内の4つのパブリックキーを入力し、最小シグネチャ番号を3に設定します（コンセンサスノード数/2+1）。

![image](http://docs.neo.org/images/2017-05-17_15-08-39.jpg)

OKをクリックします。ウォレットインデックスをリビルドするため、メニューバーの’wallet’をクリックすると、コントラクトアドレスに100万NEOが割り当てられていることが分かります。

![image](http://docs.neo.org/images/2017-05-17_15-10-14.jpg)

> [!注意]
> 4つウォレットすべてにおいてマルチシグネチャアドレスを追加する操作を実行し、ウォレットインデックスをリビルドする必要があります。

ここで、コントラクトアドレスからノーマルアドレスへNEOを送信したいです。100万NEOを受信側アドレスに送信するため、4つのウォレットのいずれかを開き、`transaction`、`transfer`をクリックし、受信側アドレスを入力します。

その後、システムは"transaction structure is completed, but there is not enough signature"とプロンプトします。コードをコピーし、2つ目のウォレットを開き、`transaction`、`transfer`をクリックし、先ほどコピーしたものを貼り付けます。`sign`をクリックし、コードをコピーし、3つ目のウォレットを開き、`transaction`, `transfer`をクリックし、先ほどコピーしたものを貼り付けます。`sign`をクリックします。このとき、`broadcast`ボタンが表示されたポップアップに気づきます。これは、トランザクションのための署名プロセスが完了した(コントラクトに必要な最小のシグネチャが達成した)ことを示します。これでトランザクションは送信できるようになり、`broadcast`をクリックします。送信トランザクションがブロードキャストを開始してから、アカウントへの送金が成功するまでにはおよそ15秒かかります。

![image](http://docs.neo.org/images/2017-05-17_15-12-50.jpg)

GASを取り出す操作も同様で、以下に示すように`Advanced`、`Claim GAS`、`Claim`をクリックします。（後で必要になるのでウォレットアドレスを覚えておいてください。）

![image](http://docs.neo.org/images/2017-05-17_15-13-29.jpg)

次の操作はNEOの送信と同様です。十分でないシグネチャを持つコードをコピーし、2つめのウォレットを開き、`transaction`、`transfer`をクリックして先ほどコピーしたものを貼り付けます。`sign`をクリックし、コードをコピーし、3つ目のウォレットを開き、`transaction`, `transfer`をクリックし、先ほどコピーしたものを貼り付けます。`sign`と`broadcast`をクリックしてGASを請求するトランザクションをブロードキャストします。請求のトランザクションがブロードキャストを開始してから、口座への送金が成功するまでおよそ15秒かかります。
取り出しが成功した後、そのGASは最初のウォレットのスタンダードアドレスに入ります（トップのウォレットアドレス）。そこで、以下に示すようにGASの取り出しを開始します。

![image](http://docs.neo.org/images/2017-05-17_15-15-45.jpg)
